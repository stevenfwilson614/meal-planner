<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Weekly Meal Planner</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      max-width: 520px;
      margin: auto;
    }
    h1 {
      text-align: center;
    }
    .row {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }
    select, button {
      margin-left: 6px;
    }
    a {
      margin-left: 6px;
    }
  </style>
</head>
<body>

<h1>Weekly Meal Planner</h1>
<div id="planner">Loadingâ€¦</div>

<script>
const SHEET_ID = "1S_NX1UxOB38aB-9As9gC8zH4BQMSuONk4g7f5jL8nmE";

const RECIPES_CSV =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

const PLAN_CSV =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=2118385531`;

function parseCSV(text) {
  const rows = [];
  let row = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const next = text[i + 1];

    if (char === '"' && inQuotes && next === '"') {
      current += '"';
      i++;
    } else if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === "," && !inQuotes) {
      row.push(current);
      current = "";
    } else if (char === "\n" && !inQuotes) {
      row.push(current);
      rows.push(row.map(c => c.trim()));
      row = [];
      current = "";
    } else {
      current += char;
    }
  }

  if (current.length || row.length) {
    row.push(current);
    rows.push(row.map(c => c.trim()));
  }

  return rows;
}


Promise.all([
  fetch(RECIPES_CSV).then(r => r.text()),
  fetch(PLAN_CSV).then(r => r.text())
]).then(([recipesText, planText]) => {

  const recipesRaw = parseCSV(recipesText).slice(1);
  const planRaw = parseCSV(planText).slice(1);

  const recipes = recipesRaw.map(r => ({
    name: r[1],
    url: r[2],
    tags: (r[3] || "").toLowerCase()
  }));

  const container = document.getElementById("planner");
  container.innerHTML = "";

  planRaw.forEach(r => {
    const day = r[0];
    const meal = r[1];

    const row = document.createElement("div");
    row.className = "row";

    const label = document.createElement("strong");
    label.innerText = `${day} ${meal}`;

    const select = document.createElement("select");
    select.innerHTML = `
      <option value="">Any</option>
      <option value="beef">Beef</option>
      <option value="chicken">Chicken</option>
      <option value="vegetarian">Vegetarian</option>
      <option value="pork">Pork</option>
    `;

    const btn = document.createElement("button");
    btn.innerText = "Generate";

    const result = document.createElement("span");

    btn.onclick = () => {
      const tag = select.value;
      const filtered = tag
        ? recipes.filter(r =>
            r.tags.split(",").map(t => t.trim()).includes(tag)
          )
        : recipes;

      if (!filtered.length) {
        result.innerText = " No matches";
        return;
      }

      const pick = filtered[Math.floor(Math.random() * filtered.length)];
      result.innerHTML = ` <a href="${pick.url}" target="_blank">${pick.name}</a>`;
    };

    row.append(label, select, btn, result);
    container.appendChild(row);
  });

}).catch(err => {
  console.error(err);
  document.getElementById("planner").innerText =
    "Failed to load meal plan.";
});
</script>

</body>
</html>
