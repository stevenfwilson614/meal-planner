<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Weekly Meal Planner</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      max-width: 520px;
      margin: auto;
    }
    h1 
    <p style="color:red;font-weight:bold;">DEBUG VERSION TWO DROPDOWNS</p>
{
      text-align: center;
    }
    .row {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }
    select, button {
      margin-left: 6px;
    }
    a {
      margin-left: 6px;
    }
  </style>
</head>
<body>

<h1>Weekly Meal Planner</h1>
<div id="planner">Loadingâ€¦</div>

<script>
const SHEET_ID = "1S_NX1UxOB38aB-9As9gC8zH4BQMSuONk4g7f5jL8nmE";
const PROTEIN_TAGS = ["Beef", "Chicken", "Fish", "Lamb", "Egg", "Tempe", "Tahu", "Pumkin", "Potatoe"];
const CUISINE_TAGS = ["Medetteranian", "Mexican", "Indonesian", "Indian"];

const RECIPES_CSV =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

const PLAN_CSV =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=2118385531`;

function parseCSV(text) {
  const rows = [];
  let row = [];
  let current = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const next = text[i + 1];

    if (char === '"' && inQuotes && next === '"') {
      current += '"';
      i++;
    } else if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === "," && !inQuotes) {
      row.push(current);
      current = "";
    } else if (char === "\n" && !inQuotes) {
      row.push(current);
      rows.push(row.map(c => c.trim()));
      row = [];
      current = "";
    } else {
      current += char;
    }
  }

  if (current.length || row.length) {
    row.push(current);
    rows.push(row.map(c => c.trim()));
  }

  return rows;
}


Promise.all([
  fetch(RECIPES_CSV).then(r => r.text()),
  fetch(PLAN_CSV).then(r => r.text())
]).then(([recipesText, planText]) => {

  const recipesRaw = parseCSV(recipesText).slice(1);
  const planRaw = parseCSV(planText).slice(1);

  const recipes = recipesRaw.map(r => ({
    name: r[1],
    url: r[2],
    tags: (r[3] || "").toLowerCase()
  }));

  const container = document.getElementById("planner");
  container.innerHTML = "";

  planRaw.forEach(r => {
    planRaw.forEach(r => {
  const day = r[0];
  const meal = r[1];

  const row = document.createElement("div");
  row.className = "row";

  const label = document.createElement("strong");
  label.textContent = `${day} ${meal}`;

  // Protein dropdown
  const proteinSelect = document.createElement("select");
  proteinSelect.innerHTML = `<option value="">Any protein</option>`;
  PROTEIN_TAGS.forEach(t => {
    const o = document.createElement("option");
    o.value = t;
    o.textContent = t.charAt(0).toUpperCase() + t.slice(1);
    proteinSelect.appendChild(o);
  });

  // Cuisine dropdown
  const cuisineSelect = document.createElement("select");
  cuisineSelect.innerHTML = `<option value="">Any cuisine</option>`;
  CUISINE_TAGS.forEach(t => {
    const o = document.createElement("option");
    o.value = t;
    o.textContent = t.charAt(0).toUpperCase() + t.slice(1);
    cuisineSelect.appendChild(o);
  });

  const btn = document.createElement("button");
  btn.textContent = "Generate";

  const result = document.createElement("span");

  btn.onclick = () => {
    const protein = proteinSelect.value;
    const cuisine = cuisineSelect.value;

    const filtered = recipes.filter(rec => {
      const tags = rec.tags.split(",").map(t => t.trim());
      if (protein && !tags.includes(protein)) return false;
      if (cuisine && !tags.includes(cuisine)) return false;
      return true;
    });

    if (!filtered.length) {
      result.textContent = " No matches";
      return;
    }

    const pick = filtered[Math.floor(Math.random() * filtered.length)];
    result.innerHTML = ` <a href="${pick.url}" target="_blank">${pick.name}</a>`;
  };

  row.append(label, proteinSelect, cuisineSelect, btn, result);
  container.appendChild(row);
});

  });

}).catch(err => {
  console.error(err);
  document.getElementById("planner").innerText =
    "Failed to load meal plan.";
});
</script>

</body>
</html>
