<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Weekly Meal Planner</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      max-width: 520px;
      margin: auto;
    }
    h1 {
      text-align: center;
    }
    .row {
      border-bottom: 1px solid #ddd;
      padding: 12px 0;
    }
    select, button {
      margin-left: 6px;
    }
    a {
      margin-left: 6px;
    }
  </style>
</head>
<body>

<h1>Weekly Meal Planner</h1>
<div id="planner">Loadingâ€¦</div>

<script>
/* ===================== CONFIG ===================== */

const SHEET_ID = "1S_NX1UxOB38aB-9As9gC8zH4BQMSuONk4g7f5jL8nmE";

/* These MUST exist in your tags column */
const PROTEIN_TAGS = ["beef", "chicken", "pork", "seafood", "vegetarian"];
const CUISINE_TAGS = ["italian", "mexican", "indonesian", "thai", "asian"];

/* ===================== CSV URLS ===================== */

const RECIPES_URL =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

const PLAN_URL =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=2118385531`;

/* ===================== CSV PARSER ===================== */
/* Handles commas inside fields correctly */

function parseCSV(text) {
  const rows = [];
  let row = [];
  let value = "";
  let insideQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const next = text[i + 1];

    if (char === '"' && insideQuotes && next === '"') {
      value += '"';
      i++;
    } else if (char === '"') {
      insideQuotes = !insideQuotes;
    } else if (char === "," && !insideQuotes) {
      row.push(value);
      value = "";
    } else if (char === "\n" && !insideQuotes) {
      row.push(value);
      rows.push(row.map(v => v.trim()));
      row = [];
      value = "";
    } else {
      value += char;
    }
  }

  if (value.length || row.length) {
    row.push(value);
    rows.push(row.map(v => v.trim()));
  }

  return rows;
}

/* ===================== LOAD DATA ===================== */

Promise.all([
  fetch(RECIPES_URL).then(r => r.text()),
  fetch(PLAN_URL).then(r => r.text())
])
.then(([recipesCSV, planCSV]) => {

  const recipesRaw = parseCSV(recipesCSV).slice(1);
  const planRaw = parseCSV(planCSV).slice(1);

  const recipes = recipesRaw.map(r => ({
    name: r[1],
    url: r[2],
    tags: (r[3] || "").toLowerCase()
  }));

  const container = document.getElementById("planner");
  container.innerHTML = "";

  planRaw.forEach(r => {
    const day = r[0];
    const meal = r[1];

    const row = document.createElement("div");
    row.className = "row";

    const label = document.createElement("strong");
    label.textContent = `${day} ${meal}`;

    /* Protein dropdown */
    const proteinSelect = document.createElement("select");
    proteinSelect.innerHTML = `<option value="">Any protein</option>`;
    PROTEIN_TAGS.forEach(t => {
      const o = document.createElement("option");
      o.value = t;
      o.textContent = t.charAt(0).toUpperCase() + t.slice(1);
      proteinSelect.appendChild(o);
    });

    /* Cuisine dropdown */
    const cuisineSelect = document.createElement("select");
    cuisineSelect.innerHTML = `<option value="">Any cuisine</option>`;
    CUISINE_TAGS.forEach(t => {
      const o = document.createElement("option");
      o.value = t;
      o.textContent = t.charAt(0).toUpperCase() + t.slice(1);
      cuisineSelect.appendChild(o);
    });

    const btn = document.createElement("button");
    btn.textContent = "Generate";

    const result = document.createElement("span");

    btn.onclick = () => {
      const protein = proteinSelect.value;
      const cuisine = cuisineSelect.value;

      const filtered = recipes.filter(rec => {
        const tags = rec.tags.split(",").map(t => t.trim());
        if (protein && !tags.includes(protein)) return false;
        if (cuisine && !tags.includes(cuisine)) return false;
        return true;
      });

      if (!filtered.length) {
        result.textContent = " No matches";
        return;
      }

      const pick = filtered[Math.floor(Math.random() * filtered.length)];
      result.innerHTML = ` <a href="${pick.url}" target="_blank">${pick.name}</a>`;
    };

    row.append(label, proteinSelect, cuisineSelect, btn, result);
    container.appendChild(row);
  });

})
.catch(err => {
  console.error(err);
  document.getElementById("planner").textContent =
    "Failed to load menu.";
});
</script>

</body>
</html>
